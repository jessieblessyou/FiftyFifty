<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script> 
<script src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.15/js/dataTables.bootstrap.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.15/css/dataTables.bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="js/dialogExtend.js"></script> 

<title>AA accounts</title>
<style>

/*.aa{
	background-color: #abb9d3;
}*/

table.dataTable tbody tr.selected{

	background-color: #abb9d3;
}

</style>
</head>
<body>
	<div class="container">
	<h4 id="clubTotal">俱乐部总金额</h4>
	<h4 id="clubLeft">俱乐部剩余金额</h4>
	</div>
	</br>
<!-- 	<div class="modal" id="myModalMember">
		<div class="modal-dialog">
			<div class="modal-content">

				<div class="modal-header">
					<button class="close" data-dismiss="modal"><span>&times;</span></button>
					<h4>添加成员</h4>
				</div>	

				<div class="modal-body">
					<form class="form-horizontal">
						<div class="form-group">
							<label class="control-label col-sm-3" for="name">姓名:</label>
							<div class="col-sm-8">
								<input type="text" id="memeberName" class="form-control"/>
							</div>
						</div>


						<div class="form-group">
							<label class="control-label col-sm-3" for="password">初始金额:</label>
							<div class="col-sm-8">
								<input type="number" class="form-control" id="memeberCash"/>
							</div>
						</div>

				</div>

				<div class="modal-footer">		
						<div class="form-group col-sm-12">
							<button type="button" class="btn btn-active" id="addMember">添加</button>
							<button type="button" class="btn btn-active" id="closeMember">关闭</button>
						</div>
					</form>	
				</div>

			</div>

		</div>	
	</div> -->
	<div id="newMembers">
	</div>
	<div class="modal" id="myModalcashMember">
		<div class="modal-dialog">
			<div class="modal-content">

				<div class="modal-header">
					<button class="close" data-dismiss="modal"><span>&times;</span></button>
					<h4>成员充值</h4>
				</div>	

				<div class="modal-body">
					<form class="form-horizontal">

						<div class="form-group">
							<label class="control-label col-sm-3" for="name">ID:</label>
							<div class="col-sm-8">
								<label class="control-label" for="name" id="cashMembeAddID"></label>
							</div>
						</div>

						<div class="form-group">
							<label class="control-label col-sm-3" for="name">金额:</label>
							<div class="col-sm-8">
								<input type="number" id="cashMembeAdd" class="form-control"/>
							</div>
						</div>
				</div>

				<div class="modal-footer">		
						<div class="form-group col-sm-12">
							<button type="button" class="btn btn-active" id="addCash">充值</button>
							<button type="button" class="btn btn-active" id="closeCashMember">关闭</button>
						</div>
					</form>	
				</div>

			</div>
		</div>	
	</div>
	<div class="modal" id="myModalTask">
		<div class="modal-dialog">
			<div class="modal-content">

				<div class="modal-header">
					<button class="close" data-dismiss="modal"><span>&times;</span></button>
					<h4>添加活动</h4>
				</div>	

				<div class="modal-body">
					<form class="form-horizontal">
						<div class="form-group">
							<label class="control-label col-sm-3" for="name">活动名:</label>
							<div class="col-sm-8">
								<input type="text" id="taskName" class="form-control"/>
							</div>
						</div>
				</div>

				<div class="modal-footer">		
						<div class="form-group col-sm-12">
							<button type="button" class="btn btn-active" id="addTask">添加</button>
							<button type="button" class="btn btn-active" id="closeTask">关闭</button>
						</div>
					</form>	
				</div>

			</div>

		</div>	
	</div>
	<div class="modal" id="myModalDelTask">
		<div class="modal-dialog">
			<div class="modal-content">

				<div class="modal-header">
					<button class="close" data-dismiss="modal"><span>&times;</span></button>
					<h4>删除活动</h4>
				</div>	

				<div class="modal-body">
					<form class="form-horizontal">
						<div class="form-group">
							<label class="control-label col-sm-3" for="name">活动名:</label>
							<div class="col-sm-8">
								<input type="text" id="delTaskName" class="form-control"/>
							</div>
						</div>
				</div>

				<div class="modal-footer">		
						<div class="form-group col-sm-12">
							<button type="button" class="btn btn-active" id="delTask">删除</button>
							<button type="button" class="btn btn-active" id="closeDelTask">关闭</button>
						</div>
					</form>	
				</div>

			</div>

		</div>	
	</div>
	<div class="modal" id="myModalTaskExpense">
		<div class="modal-dialog">
			<div class="modal-content">

				<div class="modal-header">
					<button class="close" data-dismiss="modal"><span>&times;</span></button>
					<h4>活动消费</h4>
				</div>	

				<div class="modal-body">
					<form class="form-horizontal">
						<div class="form-group">
							<label class="control-label col-sm-3" for="name">活动名称:</label>
							<div class="col-sm-8">
								<input type="text" id="taskExpenseName" class="form-control"/>
							</div>
						</div>

						<div class="form-group">
							<label class="control-label col-sm-3" for="name">ID:</label>
							<div class="col-sm-8">
								<label class="control-label" for="name" id="taskExpenseID"></label>
							</div>
						</div>


						<div class="form-group">
							<label class="control-label col-sm-3" for="password">活动消费:</label>
							<div class="col-sm-8">
								<input type="number" class="form-control" id="taskExpenseNumber"/>
							</div>
						</div>

				</div>

				<div class="modal-footer">		
						<div class="form-group col-sm-12">
							<button type="button" class="btn btn-active" id="taskExpenseAdd">消费</button>
							<button type="button" class="btn btn-active" id="closeTaskExpense">关闭</button>
						</div>
					</form>	
				</div>

			</div>

		</div>	
	</div>	
	<div class="container">
<!-- 	<button type="button" class="btn btn-default" data-toggle="modal" data-target="#myModalMember">添加成员</button> -->
<button type="button" class="btn btn-default" data-toggle="modal" data-target="#my_Modal_Member" id="add_members">添加成员</button>
	<button type="button" class="btn btn-default" data-toggle="modal"  id="cashMember">成员充值</button>
	<button type="button" class="btn btn-default" id="delMember">删除成员</button>
	<button type="button" class="btn btn-default" data-toggle="modal" data-target="#myModalTask">添加活动</button>
	<button type="button" class="btn btn-default" data-toggle="modal" id="taskExpense">活动消费</button>
	<button type="button" class="btn btn-default" data-toggle="modal" data-target="#myModalDelTask" id="delTask">删除活动</button>
	</div>	
	<br>
	<div id="outer" class="container">
   		<table id="example" cellspacing="0" width="100%" class="table  table-striped table-bordered table-hover">  
        <thead>
        </thead>
        <tbody>
        </tbody>      
    </table>	
	</div>

	<br>
	<br>	
</body> 
<script>
 var strategies={

 	"isNonEmpty":function(value,errorMsg)
 	{
 		if(value=="")
 		{
 			return errorMsg;
 		}
 	},
 	"isNonUndefined":function(value,errorMsg)
 	{
 		if(value==undefined)
 		{
 			return errorMsg;
 		}
 	},
 	"isNonPositiveNumber":function(value,errorMsg)
 	{
 		if(value<=0)
 		{
 			return errorMsg;
 		}
 	},
 	"isNonInt":function(value,errorMsg)
 	{
 		var value =value+"";

		if(value.indexOf(".")>0)
		{	 
			return errorMsg;
		}
 	},
 	"isNonSpecail":function(value,errorMsg)
 	{
 		if(value=="ID" || value=="姓名" || value=="现金" || value=="剩余")
		{
			return errorMsg;
		};
 	}
 }

 var validation=function()
 {
 	this.cache=[];
 };


 validation.prototype.add=function(dom,rule,Msg)
 {
 	this.cache.push(strategies[rule](dom.val(),Msg));
 };

 validation.prototype.execute=function()
 {
 	 for(var i=0;i<this.cache.length;i++)
 	 {
 	 	var msg=this.cache[i];

 	 	//console.log(msg);

 	 	if(msg)
 	 	{
 	 		alert(msg);
 	 		return false;
 	 	}
 	 }
 };
</script>

<script>

window.onload=function()
{
	//console.log("1");

	getTask();
	getTotalCash();
	getLeftCash();

	$('#example tbody').on( 'click', ':checkbox', function () {
    	$(this).parent().parent().toggleClass('selected');
	} );

}

// $("#addMember").click(function()
// {
// 	var a=$("#memeberName");
// 	var b=$("#memeberCash");

// 	if(a.val()=="" || b.val()=="")
// 	{
// 		alert("请输入正确的信息");

// 		return;
// 	}

// 	var str="memeberName="+a.val()+"&&memeberCash="+b.val();

// 	$.ajax({  
//                     type : "POST",  //提交方式  
//                     url : "addName.php",//路径 
//                     data:str ,
//                     success : function(result) {//返回数据根据结果进行相应的处理  
                        
//                         //console.log(result);

//                         if(result==1)
//                         {
//                         	a.val("");
//                         	b.val("");

//                         	alert("添加成功");
//                         }
//                     }  
//                 });  
// });


// $("#closeMember").click(function(){

// 	$('#myModalMember').modal('hide');
// });
$('#add_members').click(function()
	{
		var a={

			id:'my_Modal_Member',
			header:'',
			body:'',
			footer:''
		}


		    a.header=' <button class="close" data-dismiss="modal"><span>&times;</span></button><h4>添加成员</h4>';
		    a.body='<form class="form-horizontal"><div class="form-group">';
		    a.body=a.body+'<label class="control-label col-sm-3" for="name">姓名:</label>';
		    a.body=a.body+'<div class="col-sm-8"><input type="text" id="member_Name" class="form-control"/></div></div>';
		    a.body=a.body+' <div class="form-group"><label class="control-label col-sm-3" for="password">初始金额:</label>';
		    a.body=a.body+'<div class="col-sm-8"><input type="number" class="form-control" id="member_Cash"/></div></div>';

		    a.footer=' <div class="form-group col-sm-12">';
		    a.footer=a.footer+'<button type="button" class="btn btn-active" id="add_Member">添加</button>';
		    a.footer=a.footer+'<button type="button" class="btn btn-active" id="close_Member">关闭</button>';
		    a.footer=a.footer+'</form>';

		$("#newMembers").newDialog(a);

	});

	$('#newMembers').on( 'click', '#add_Member', function () {
   
    	var b=new validation();
    	var c=$("#member_Name");
		var d=$("#member_Cash");

		console.log(c.val());

		b.add(c,"isNonEmpty","姓名不能为空");
		b.add(c,"isNonUndefined","姓名不能为空");
		b.add(d,"isNonEmpty","金额不能为空");
		b.add(d,"isNonUndefined","金额不能为空");
		b.add(d,"isNonPositiveNumber","金额不能为负数");
		b.add(d,"isNonInt","金额不能为小数");

		var res=b.execute();

		console.log(res);

		if(res==false)
		{
			return;
		};

		var str="memeberName="+c.val()+"&&memeberCash="+d.val();

		$.ajax({  
                    type : "POST",  //提交方式  
                    url : "addName.php",//路径 
                    data:str ,
                    success : function(result) {//返回数据根据结果进行相应的处理  
                        
                        //console.log(result);

                        if(result==1)
                        {
                        	c.val("");
                        	d.val("");

                        	alert("添加成功");
                        }
                    }  
             });  
	} );

	$('#newMembers').on( 'click', '#close_Member', function () {   
		$('#my_Modal_Member').modal('hide');
	} );

$("#addTask").click(function()
{
	var a=$("#taskName");

	if(a.val()=="" || a.val()==undefined)
	{
		alert("请输入正确的信息");

		return;
	}

	if(a.val()=="ID" || a.val()=="姓名" || a.val()=="现金" || a.val()=="剩余")
	{
		alert("请务输入ID,姓名，现金，剩余");

		return;
	};

	var str="taskName="+a.val();

	console.log(str);

	$.ajax({  
                    type : "POST",  //提交方式  
                    url : "addTask.php",//路径 
                    data:str ,
                    success : function(result) {//返回数据根据结果进行相应的处理  
                        
                        console.log(result);

                        if(result==1)
                        {
                        	a.val("");

                        	alert("添加成功");
                        }
                        else
                        {
                        	alert("添加失败");
                        }	
                    }  
                });  
});

$("#closeTask").click(function(){

	$('#myModalTask').modal('hide');
});

function getTask()
{
	$.ajax({  
        type : "GET",  //提交方式  
        url : "getTitle.php",//路径 
        success : function(result) {//返回数据根据结果进行相应的处理  
            
            console.log(result);
            var a=JSON.parse(result);
            //console.log(typeof a);

            $('#example').dataTable( {  
            "dom": 'ft',	
        	"processing": true,//显示加载进度条  
        	"serverSide": true,//开启服务器端模式  
        	"ajax": "getDataStrong.php", 
        	"lengthMenu":[null,null,null,null], 

        	'columnDefs': [{
		         'targets': 0,
		         'searchable': false,
		         'orderable': false,
		         'className': 'check',
		         'render': function (data, type, rows, meta){

		             return '<input type="checkbox"  onchange="del(\''+data+'\')">';
		         }
		      }],

            "columns": a,
   		} );  
    }        

    });

};

function getTotalCash()
{
	$.ajax({  
        type : "GET",  //提交方式  
        url : "getTotalCash.php",//路径 
        success : function(result) {//返回数据根据结果进行相应的处理  
            
            console.log(result);

            $("#clubTotal").html("俱乐部总金额:"+result+"元"); 

        }  
    });  
};

function getLeftCash()
{
	$.ajax({  
        type : "GET",  //提交方式  
        url : "getTotalLeft.php",//路径 
        success : function(result) {//返回数据根据结果进行相应的处理  
            
            console.log(result);

            $("#clubLeft").html("俱乐部剩余金额:"+result+"元"); 

        }  
    });  
}

var total=[];

function del(data)
{

	for(var i=0;i<total.length;i++)
	{

		if(total[i]==data)
		{
			total.splice(i,1);
			return;
		};

	};

	total.push(data);
	console.log(total);

	//console.log(typeof data);
};

$("#delMember").click(function()
{
	if(total.length==0)
	{
		alert("请用复选框做选择");
	}
	else if(total.length>1)
	{
		alert("请只选择一个人");
	}
	else
	{	

		var r=confirm("确定要删除ID "+total[0]);

		if(r==true)
		{
			$.ajax({  
		        type : "POST",  //提交方式  
		        url : "deleteName.php",//路径 
		        data:"data="+total[0] ,
		        success : function(result) {//返回数据根据结果进行相应的处理  
		            
		            //console.log(result);
		            if(result==1)
		            {
		            	alert("删除成功");
		            };
		          
		    	}  
    		}); 
		}	

	}	
});


$("#delTask").click(function()
{
	var a=$("#delTaskName");

	if(a.val()=="" || a.val()==undefined)
	{
		alert("请输入正确的信息");

		return;
	};

	if(a.val()=="ID" || a.val()=="姓名" || a.val()=="现金" || a.val()=="剩余")
	{
		alert("请务输入ID,姓名，现金，剩余");

		return;
	};

	$.ajax({  
		        type : "POST",  //提交方式  
		        url : "deleteTask.php",//路径 
		        data:"data="+a.val(),
		        success : function(result) {//返回数据根据结果进行相应的处理  
		            
		            console.log(result);

		            if(result==0)
		            {
		            	alert("查无此活动，请重新输入");
		            }
		            else if(result==1) 
		            {
		            	                   
                    	a.val("");

                    	alert("删除成功");
                     
		            }			      
		    } 
	}); 	     

});

$("#closeDelTask").click(function()
{
	$('#myModalDelTask').modal('hide');
});

$("#cashMember").click(function()
{	

	//$('#myModalcashMember').modal('hide');

	if(total.length==0)
	{
		alert("请用复选框做选择");
		//$('#myModalcashMember').modal('show');

		//alert("a");
	}
	else if(total.length>1)
	{
		alert("请只选择一个人");
	}
	else
	{
		$('#myModalcashMember').modal('show');
		$("#cashMembeAddID").html(total[0]);
	}	

});

$("#addCash").click(function(){

	var a=$("#cashMembeAdd");

	if(a.val()=="" || a.val()==undefined)
	{
		alert("请输入正确的信息");
		return;
	};

	var judge=judgeNumber(a.val());

	if(judge==0)
	{
		alert("请输入整数");

		return;
	};

	var str="cashID="+total[0]+"&&cashNumber="+a.val();

	console.log(str);

	$.ajax({  
                    type : "POST",  //提交方式  
                    url : "addCash.php",//路径 
                    data:str,
                    success : function(result) {//返回数据根据结果进行相应的处理  
                        
                       	console.log(result);

                        if(result==1)
                        {
                        	a.val("");

                        	alert("充值成功");
                        }
                    }  
                });  
});

$("#closeCashMember").click(function()
{
	$('#myModalcashMember').modal('hide');
});


$("#taskExpense").click(function()
{	

	var str="";

	if(total.length==0)
	{
		alert("请用复选框做选择参与人员");
		//$('#myModalcashMember').modal('show');

		//alert("a");
	}
	else
	{
		$('#myModalTaskExpense').modal('show');

		for(var i=0;i<total.length;i++)
		{
			str=str+total[i]+",";
		};

		str = str.substr(0,str.length-1);

		$("#taskExpenseID").html(str);
	}	

});

$("#taskExpenseAdd").click(function()
{
	var a=$("#taskExpenseName");
	var b=$("#taskExpenseNumber");
	var c=$("#taskExpenseID");

	if(a.val()=="" || a.val()==undefined || b.val()=="" || b.val()==undefined)
	{
		alert("请输入正确的信息");

		//alert(total.length);

		return;
	};

	if(a.val()=="ID" || a.val()=="姓名" || a.val()=="现金" || a.val()=="剩余")
	{
		alert("请务输入ID,姓名，现金，剩余");

		return;
	};

	var judge=judgeNumber(b.val());

	if(b.val()<=0 || judge==0)
	{
		alert("请输入正整数");

		return;
	};

	var divide=b.val()/total.length;

	console.log(divide);

	var judgeDivide=judgeNumber(divide);

	if(judgeDivide==0)
	{
		alert("无法平分为整数，请重新输入");
		return;
	}


	var str="taskName="+a.val()+"&&expenseNumber="+divide+"&&memberID="+c.html();

	console.log(str);

	$.ajax({  
                    type : "POST",  //提交方式  
                    url : "addExpense.php",//路径 
                    data:str,
                    success : function(result) {//返回数据根据结果进行相应的处理  
                        
                       	console.log(result);

                        if(result==4)
                        {
                        	alert("活动不存在");
                        }
                        else if(result==2)
                        {
                        	alert("有ID已参与过选中的活动,请重新选择");
                        }
                        else if(result==1)
                        {
                        	alert("消费成功");
                        }
                        else if(result==5)
                        {
                        	alert("未能记录至数据库");
                        }	
                    }  
            });  

});

$("#closeTaskExpense").click(function()
{
	$('#myModalTaskExpense').modal('hide');
});

var judgeNumber=function(number)
{
	var str = number+"";

	if(str.indexOf(".")==-1)
	{	 
		return 1;
	}
	else
	{
		return 0;
	}

};


</script>	
</html>

